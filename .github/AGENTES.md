# AI Agent 作業ガイドライン

以下は、AI Agent がファイル操作・Git 操作・最適化作業を行う際の標準プロトコルである。
Agent は **必ずこの文書の規則を最優先で適用すること。**

---

# 1. Branch Handling Rules（ブランチ操作）

Git 操作はローカル実行権限がある場合のみ実行する。

1. ファイル変更前にブランチ名を確認：  
   `git branch --show-current`

2. ブランチが `main` or `master` の場合は編集禁止。  
   - `main` or `master` の場合、ローカルのレポジトリがリモートリポジトリの最新の状態であることを確認する
   - 最新の状態でなければ、最新の状態にする
   - ローカルが最新でない場合：
      - `git fetch origin` を実行する。
      - `git status -uno` を実行し、ローカルの main/master が origin/main/master と一致していることを確認する。
      - 差分がある場合は `git pull --ff-only` で fast-forward 可能な場合のみ更新する。
      - fast-forward できない場合は、ユーザーに状況を報告し、指示を仰ぐ。
   - 最新の状態であることが確認出来たら、次のメッセージを表示：  
   - 「作業用ブランチを作成してよいですか？ 推奨: `feature/<task-slug>`」

3. 承認されたらブランチ作成：  
   `git switch -c feature/<task-slug>`

4. `<task-slug>` のルール：  
   - 英語 3〜6 語  
   - 英小文字  
   - ハイフン区切り（例：optimize-color-mapping）
   - タスク記述を3〜6語の主要な英単語に要約し、ハイフン区切りでブランチ名とする

5. ブランチ切り替え成功後のみ編集を開始する。

6. `git switch -c feature/<task-slug>` が失敗した場合
   - 例えば
      - 既に同名ブランチが存在する
      - 作業ツリーにコミットされていない変更がある
   - これらのケースでは、エラー内容をそのままユーザーに提示し、次のいずれかの方針について指示を求めること。

---

# 2. コミット前の作業

## 2-1. コードスタイルチェック

- 以下のコマンドは、ソリューションファイル（.sln）が存在するディレクトリ、または対象プロジェクトのルートで実行する。

1. 権限がある場合、まずチェックコマンドを実行する： `dotnet format --verify-no-changes`
2. 上記コマンドがエラー（変更が必要）となった場合、フォーマットを自動修正してよいかユーザーに確認する。 「`dotnet format` を実行してコードスタイルを修正してもよいですか？」
3. 承認された場合: `dotnet format` を実行する。
4. 権限がない場合: （現状のまま、目視できる範囲で指摘する）

- `dotnet format` コマンドが存在しない場合は、エラー内容を報告し、自動フォーマットは行わず、目視できる範囲でスタイルの問題を指摘するに留める。

## 2-2. Build & Test
- 権限がある場合：  
  `dotnet build`  
  `dotnet test`

- 権限がない場合：  
  ユーザーに`dotnet build`, `dotnet test`を行うようユーザーに促す

## 2-3. 不要ファイルの除去

- デバッグ用のログ出力（Console.WriteLine, Debug.WriteLine など）は、コミット前に削除する。ただし、明確な運用上の意味を持つログ出力（ロギングライブラリを用いたものなど）は削除しない。
- 未使用 using は削除してよい。
- `.vscode/`, `.vs/`, `bin/`, `obj/` などビルド・IDE生成物は、Git 管理下にない前提で扱い、内容を変更しない。


---

# 3. コミット作成ルール

1. Conventional Commits に準拠
   - コミットメッセージの subject（1 行目）は英語・50 文字以内とする。必要に応じて body に詳細を書いてよい。
   - 使用する type は次のいずれかとする: `feat`, `fix`, `perf`, `refactor`, `docs`, `test`, `chore`, `build`, `ci`, `style`, `revert`
2. 論理単位でコミット分割  

---

# 4. 最適化目的の作業（特殊ルール）

## 4-1. baseline の定義
- baseline は **main ブランチの最新 stable commit** を checkout して取得する。
   - stable commitは、mainブランチの最新のリリース タグ （例: v1.2.0）を指す
   - リポジトリにリリースタグ（例: v1.2.0）が存在しない場合は、main ブランチの HEAD を baseline とみなす。


## 4-2. ベンチマーク保存ルール
- `/benchmarks/<slug>.md` に保存  
- コードは `/benchmarks/src/` に置く  
- 改善後も同条件で実行

## 4-3. コミット内容
commit message に以下を含める：

- 目的  
- 改善内容  
- ベンチマーク概要  

## 4-4. タグ付与

- 最適化完了コミットには lightweight tag `perf/<task-slug>` を付与する。
- もしくは、ユーザーが設定したバージョンタグ運用がある場合は、そのルールに従い、勝手に新しいバージョン番号を発行しない。


---

# 5. ドキュメント更新ポリシー

## 5-1. 更新タイミング

- コード変更に伴い公開ドキュメント（README, USAGE 等）の更新が必要な場合、開発ブランチでは docs/drafts/ にドラフトを作成する。
- docs/drafts/ には、更新対象ドキュメントと対応付けやすいファイル名を付ける（例: README.update-<task-slug>.md）。
- main にマージする PR では、対応する README 等を更新し、docs/drafts/ 内の該当ドラフトファイルを削除する。


## 5-2. 更新ルール
- コード変更に応じて必ず更新  
- 使用例・注意点を明記  
- スタイルガイドに従う  

---

# 6. NuGet パッケージ公開前チェック

- このセクションのチェックは、ユーザーから「NuGet パッケージを公開したい」「リリース準備をしてほしい」といった明示的な指示があった場合にのみ実行する。

1. README/USAGE が、現在のコードの仕様と整合性がとれているか確認
   - とれていない場合、修正案を作成し、ユーザーに確認する
2. CHANGELOG を更新  
3. テストが全て成功 することを確認
4. .csproj ファイルに記述されている <PackageId>, <Version>, <Authors>, <Description> などの主要なメタデータ項目をユーザーに提示し、内容が正しいか確認を求める。
5. テストプロジェクトを作成して、パッケージの動作確認
   - `dotnet pack` を実行する。
   - `dotnet new console -o ../TempTestApp` のように一時的なテストプロジェクトを作成する。
   - `dotnet add ../TempTestApp package <PackageName> --source ../<PathToNupkgFolder>` のようにローカルの nupkg を参照してパッケージを追加できるか試す。
   - テスト完了後、ユーザーの指示がない限り、一時的なテストプロジェクト（例: `../TempTestApp`）は削除してよい。
6. READMEに記載のライセンスに対応するライセンスファイル（LICENSE）またはSPDXの記載が最新の状態でパッケージに含まれていることを確認する
7. dotnet list package --vulnerable で脆弱性スキャン
8. リリースコミット

---

# 7. Agent 汎用ルール

- 不明点は必ず質問してから続行。  
- 3 ファイル以上 または 100 行以上の変更がある場合は作業計画を提示し承認を得る。

- 作業計画は次の形式で提示する：
  1. 目的
  2. 変更対象ファイル一覧
  3. 各ファイルで行う主な変更内容
- ユーザーの承認を得てから実際の変更を行う。